<form class="main-form" id="sale-form" method="post" action="{{ url_for('sale') }}">
    <div class="sf-upper">
        <div class="form-part">
            <div class="sf-group">
                <div class="sf-form-input" id="sale_type-block">
                    <h4>Type</h4>
                    <select disabled>
                        <option selected>Faktura</option>
                    </select>
                </div>
                <div class="sf-form-input" id="date-block">
                    <h4>Dato</h4>
                    {{ form.date(**{"onchange":"update_maturity_date();"}) }}
                </div>
                <div class="sf-form-input" id="days_to_maturity-block">
                    <h4>Dager til forfall</h4>
                    <input id="days_to_maturity" name="days_to_maturity" min="0" required type="number" onchange="check_days_to_maturity(); update_maturity_date();">
                    <div class="empty"></div>
                    <p id="maturity-text">Forfallsdato: dd.mm.åå</p>
                </div>
                <div class="sf-form-input" id="comment-block">
                    <h4 id="comment">Kommentar</h4>
                    {{ form.comment(rows='3') }}
                </div>
                <div class="sf-form-input" id="account_number-block">
                    <h4>Kontonummer</h4>
                    <select id="account_number" name="account" required>
                        <option disabled selected value> Velg kontonummer </option>
                        {% for account_string, account in bank_accounts %}
                        <option value="{{ account["href"] }}">{{ account_string }}</option>
                        {% endfor %}
                    </select>
                    <div class="empty"></div>
                    <input disabled class="sf-button disabled_func" id="new-account-button" type="button" value="Opprett ny">
                </div>
            </div>
        </div>
        <div class="sf-reference-block">
            <div class="form-part" id="sf-reference">
                <div class="sf-form-input" id="contact-block">
                    <h4>Kontakt</h4>
                    <select id="contact" name="customer" required>
                        <option disabled selected value> Velg kunde </option>
                        {% for customer_string, customer in customers %}
                            <option value="{{ customer["href"] }}">{{ customer_string }}</option>
                        {% endfor %}
                    </select>
                    <div class="empty"></div>
                    <input class="modal_button" id="supplier-button" type="button" value="Opprett ny">
                </div>
                <div class="sf-form-input" id="our_reference-block">
                    <h4>Vår referanse</h4>
                    {{ form.our_reference }}
                </div>
                <div class="sf-form-input" id="their_reference-block">
                    <h4>Deres referanse</h4>
                    {{ form.their_reference }}
                </div>
            </div>
            <div class="empty" id="reference-fill"></div>
        </div>

    </div>
    <div class="sf-lower">
        <div class="form-part">
            <div id="sf-lines-top-big">
                <h4>Beskrivelse</h4>
                <h4>Pris</h4>
                <h4>Rabatt</h4>
                <h4>Antall</h4>
                <h4>Mva</h4>
            </div>
            <div id="sf-lines-top-small">
                <p id="line-text">Varelinjer</p>
            </div>
            <div id="sf-lines">
            </div>
            <div class="sf-lines-bottom">
                <h4 class="total-amount" id="sf-total">0.00 (0.00 inkl. mva)</h4>
                <input class="sf-button" type="button" Value="Ny produkt-linje" onclick="add_product_line()">
                <input class="sf-button" type="button" Value="Ny fritekst-linje" onclick="add_freetext_line()">
            </div>
        </div>
        <div class="form-part">
        <div class="pf-buttons">
            <input class="button-red" type="button" value="Slett utkast" onclick="clear_sale_form()">
            <input class="button-green" type="submit" value="Opprett faktura">
        </div>
    </div>
    </div>
</form>
<script>
/**
 * JavaScript for sale widget.
 */

//Update date to current date
document.getElementById("date").value = get_current_date();
//Restrict dates
restrict_dates();

/**
 * Restrict the choice of dates on the page to only dates this year.
 */
function restrict_dates() {
    let date = document.getElementById('date');
    let today = new Date();
    let this_year = today.getFullYear();
    let min_date = this_year+'-01-01';
    let max_date = this_year+'-12-31';
    date.setAttribute("min", min_date);
    date.setAttribute("max", max_date);
}

// -- Line selection
/**
 * Adds a new product line to sale form.
 */
function add_product_line() {
    let id = "sf-line-" + counter;
    let product_line = createHTML("product_line");
    addElement("sf-lines", "sf-line", "div", id, product_line);
    update_sale_lines();
}

/**
 * Adds a new freetext line to sale form.
 */
function add_freetext_line() {
    let id = "sf-line-" + counter;
    let freetext_line = createHTML("freetext_line");
    addElement("sf-lines", "sf-line", "div", id, freetext_line);
    update_sale_lines();
}

/**
 * Gets the current date and returns it as an ISO string.
 * @return: Current date as an ISO string.
 */
function get_current_date() {
    let time = new Date();
    return time.toISOString().substr(0, 10);
}


/**
 * Update maturity date according to days to maturity
 */
function update_maturity_date() {
    let days = document.getElementById("days_to_maturity").value;
    let send_date = document.getElementById('date').value;
    let time = new Date(send_date);
    time.setDate(time.getDate()+Number(days));
    let day = time.getDate();
    let month = time.getMonth() + 1;
    let year = time.getFullYear();
    document.getElementById("maturity-text").innerHTML = "Forfallsdato: " + day +"." + month + "." + year;
}

/**
 * Checks if days to maturity is valid input
 */
function check_days_to_maturity() {
    let days_to_maturity = document.getElementById('days_to_maturity');
    if (!(/^(?=.)([+-]?([0-9]*)(\.([0-9]+))?)$/.test(String(days_to_maturity.value)))
        || days_to_maturity.value.startsWith('-')) {
        days_to_maturity.value = 0;
    }
}

/**
 * Removes a line in purchase form.
 * @param id The id of line to be removed.
 */
function remove_sale_line(id) {
    let sf_lines = document.getElementById("sf-lines");
    if (sf_lines.children.length > 1){
        removeElement(id);
    } else {
        // TODO - Flash if only one element is left
        console.log("Cant remove line");
    }
    update_sale_lines();
}

/**
 * Clears the purchase form for input and deletes lines.
 */
function clear_sale_form() {
    document.getElementById("sale-form").reset();
    for (let i = 1; i < counter; i++) {
        let id = "sf-line-"+i;
        remove_sale_line(id);
    }
    update_sale_lines();
}

/**
 * Update sale line total values
 */
function update_sale_lines() {
    change_sale_line_total();
    change_sale_total();
}

/**
 * Change the total amount per line
 */
function change_sale_line_total() {
    for (let i = 1; i < counter; i++){
        let price_pointer = document.getElementById("price-"+i);
        let discount_pointer = document.getElementById("discount-"+i);
        let amount_pointer = document.getElementById("amount-"+i);
        if (price_pointer != null) {
            let price = price_pointer.value;
            let discount = discount_pointer.value;
            let amount = amount_pointer.value;
            let total = amount*price;
            if (discount > 0) {total = total*(1-(discount/100))}
            document.getElementById("sf-line-total-"+i).innerHTML = total.toFixed(2);
        }
    }
}

/**
 * Changes the total amount in total.
 */
function change_sale_total() {
    let total = document.getElementById("sf-total");
    let gross_amount = 0;
    for (let i = 1; i < counter; i++){
        let total_pointer = document.getElementById("sf-line-total-"+i);
        if (total_pointer != null) {
            gross_amount += Number(total_pointer.innerHTML)
        }
    }
    let total_mva = get_total_mva();
    let total_amount = total_mva + gross_amount;
    total.innerHTML = gross_amount.toFixed(2) + " " + "(" + total_amount.toFixed(2) + " inkl. mva)"
}

/**
 * Gets the total mva to be paid.
 */
function get_total_mva() {
    let sale_vats = document.getElementsByName('sale_vat');
    let prices = document.getElementsByName('total');
    let prices_free = document.getElementsByName('total_free');
    let sale_vats_free = document.getElementsByName('sale_vat_free');
    let mva_total = 0;
    for (let i = 0; i < prices.length; i++) {
        let mva_field = sale_vats[i].options[sale_vats[i].options.selectedIndex];
        if (mva_field != null) {
            let mva = parseFloat(mva_field.value);
            let mvaPercentage = mva / 100;
            let price = parseFloat(prices[i].textContent);
            mva_total += mvaPercentage * price;
        }
    }
    for (let i = 0; i < prices_free.length; i++) {
        let mva_text = sale_vats_free[i].options[sale_vats_free[i].options.selectedIndex].text;
        let mva = parseFloat(mva_text.split('(')[0].trim());
        let mva_percentage = mva / 100;
        let price = parseFloat(prices_free[i].textContent);
        mva_total += mva_percentage * price;
    }

    return mva_total;

}

/**
 * Validates that the discount-field with the given counter is set to strictly numerical and between 0 and 100.
 * If it is not, the value is set to 0 or 100, depending on whats closest to the actual input.
 */
function check_discount(counter) {
    let discount = document.getElementById("discount-"+counter);
    if (discount.value < 0) {
        discount.value = 0;
        update_sale_lines()
    }
    else if (discount.value > 100) {
        discount.value = 100;
        update_sale_lines()
    }
    else if  (!(/^(?=.)([+-]?([0-9]*)(\.([0-9]+))?)$/.test(String(discount.value)))) {
        discount.value = 0;
        update_sale_lines()
    }
    else if (discount.value.startsWith('-')) {
        discount.value = 0;
        update_sale_lines()
    }
}

/**
 * Validates that the amount-field with the given counter is set to strictly numerical.
 * If it is not, the value is set to 0.
 */
function check_amount(counter) {
    let amount = document.getElementById('amount-'+counter);
    if  (!(/^[0-9]{1,6}$/.test(String(amount.value)))) {
        amount.value = 0;
        update_sale_lines()
    }
    else if (amount.value.startsWith('-') || amount.value.startsWith('+')) {
        amount.value = 0;
        update_sale_lines()
    }
}

/**
 * Validates that the price-field with the given counter is set to strictly numerical.
 * If it is not, the value is set to 0.
 * @param counter: The count of the price field to be checked.
 */
function check_price(counter) {
    let price = document.getElementById('price-'+counter);
    if (!(/^(?=.)([+-]?([0-9]*)(\.([0-9]+))?)$/.test(String(price.value))) || price.value.startsWith('-')) {
        price.value = 0;
        update_sale_lines()
    }
}

/**
 * Gets the price of the product and inserts it in form.
 * @param counter: The count of the mva to be updated
 */
function updateSinglePrice(counter) {
    let products = document.getElementById("product-"+counter);
    let prod = products.options[products.selectedIndex].text;
    let price = prod.split('(')[1].split(',')[0].split(':')[1].split(')')[0].trim();
    let price_field = document.getElementById('price-'+counter);
    price_field.value = price;
    update_sale_lines();
}

/**
 * Updates the mva according to the product chosen.
 * @param counter: The count of the mva to be updated
 */
function updateMva(counter) {
    let products = document.getElementById("product-" + counter);
    let selectedProd = products.options[products.selectedIndex].value;
    let mvaType = selectedProd.split(',')[1].trim();
    let mva = "NaN";
    if (mvaType == 'HIGH') {
        mva = '25%';
    }
    else if (mvaType == 'NONE' || mvaType == 'EXEMPT_REVERSE' || mvaType == "OUTSIDE" || mvaType == "EXEMPT_IMPORT_EXPORT" || mvaType == "EXEMPT") {
        mva = '0%';
    }
    else if (mvaType == 'LOW') {
        mva = '12%';
    }
    else if (mvaType == 'RAW_FISH') {
        mva = '11.11%';
    }
    else if (mvaType == 'MEDIUM') {
        mva = '15%';
    }

    // Update the value in the form
    let mvaBox = document.getElementById("sale_vat-" + counter);
    removeOptions(mvaBox);
    mvaBox.options[0] = new Option(mva);
    mvaBox.selectedIndex = 0;
}

/**
 * Updates the values of the mva drop-down for free-text with the given counter based on chosen product-type.
 * @param counter: The count of the mva to be updated
 */
function updateMvaFree(counter) {
    let radios = document.getElementsByName("sale_type_free-"+counter);
    let sel = document.getElementById("sale_vat-"+counter);

    for (let i = 0; i < radios.length; i++) {
        if (radios[i].checked) {
            // Remove prev options before populating
            removeOptions(sel);
            if (radios[i].value == '1' || radios[i].value == '2') {
                // Populate for sale of commodity
                sel.options[sel.options.length] = new Option('25% (Vanlige salg til Norge med 25% mva.)', 3);
                sel.options[sel.options.length] = new Option('15% (Vanlige salg til Norge med 15% mva. Næringsmidler etc.)', 31);
                sel.options[sel.options.length] = new Option('11,11% (Råfisk. Kun dersom firmaets primære salsgsobjekt)', 32);
                sel.options[sel.options.length] = new Option('Fritatt (Salg som er fritatt for avgift)', 5 );
                sel.options[sel.options.length] = new Option('Utførsel (Varer som er fritatt for mva. ved eksport)', 52);
                sel.options[sel.options.length] = new Option('Utenfor (Salg til Norge som ligger utenfor merverdiavgiftsloven)', 6);
            }
            else if (radios[i].value == '3') {
                sel.options[sel.options.length] = new Option('25% (Vanlige salg til Norge med 25% mva.)', 3);
                sel.options[sel.options.length] = new Option('12% (Vanlige salg til Norge med 12% mva. Oftest transport.)', 31);
                sel.options[sel.options.length] = new Option('Fritatt (Salg som er fritatt for avgift)', 5 );
                sel.options[sel.options.length] = new Option('Utførsel (Varer som er fritatt for mva. ved eksport)', 52);
                sel.options[sel.options.length] = new Option('Utenfor (Salg til Norge som ligger utenfor merverdiavgiftsloven)', 6);
            }
        }
    }
}

/**
 * Takes a selectbox object and removes all its options.
 * @param select: The select DOM to remove all options.
*/
function removeOptions(select) {
    let length = select.options.length;
    for(let i = 0; i < length; i++)
    {
        select.remove(0);
    }
}

/**
 * Creates HTML for document based on type.
 * This includes parts of the HTML that are frequently reused, with the possibility to add and delete on click.
 * Examples are a product line, thats added every time the user presses the "add product-line" button.
 * @param type The HTML type
 * @returns {string} The HTML for specific type.
 */
function createHTML(type) {
    if (type === "product_line") {
        return `
            <div class="description-column">
                <div class="sf-line-input">
                    <select id="product-${counter}" name="product" onchange="updateMva(${counter}); updateSinglePrice(${counter}); update_sale_lines();" required>
                        <option disabled selected value>Velg produkt</option>
                        {% for product_string, product in products %}
                        <option value="{{ product['href'] }}, {{ product["vatType"] }}">{{ product_string }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="sf-line-input">
                    <h4 class="sf-header-hidden">Kommentar</h4>
                    <input id="sale_comment-${counter}" name="description" type="text" placeholder="Kommentar (ikke påkrevd)">
                </div>
            </div>
            <div class="sf-line-input line-split">
                <h4 class="sf-header-hidden">Pris</h4>
                <input id="price-${counter}" name="price" type="text" value="0.00" onchange="update_sale_lines(); check_price(${counter});">
            </div>
            <div class="sf-line-input line-split">
                <h4 class="sf-header-hidden">Rabatt</h4>
                <input id="discount-${counter}" min="0" max="100" name="discount" type="text" value="0.00" onchange="update_sale_lines(); check_discount(${counter})">
            </div>
            <div class="sf-line-input line-split">
                <h4 class="sf-header-hidden">Antall</h4>
                <input id="amount-${counter}" name="quantity" type="number" value="1" onchange="update_sale_lines(); check_amount(${counter});">
            </div>
            <div class="sf-line-input line-split">
                <h4 class="sf-header-hidden">Mva</h4>
                <select id="sale_vat-${counter}" name="sale_vat" onchange="update_sale_lines()" disabled>
                </select>
            </div>
            <div class="sf-line-input sf-line-button">
                <p class="sf-line-total" id="sf-line-total-${counter}" name="total">0.00</p>
                <input class="sf-button" id="sf-button-${counter}" name="delete_line" type="button" Value="Slett linje" onclick="remove_sale_line(this.parentNode.parentNode.id)">
            </div>
            `;
    }
    else if (type === "freetext_line") {
        return `
            <div class="description-column">
                <div class="sf-line-input">
                    <h4 class="sf-header-hidden">Tekst</h4>
                    <input id="description" name="description_free" type="text" placeholder="Beskrivelse" required>
                </div>
                <ul class="sf-line-input" id="sale-type">
                    <li>
                        <input onchange="updateMvaFree(${counter});" name="sale_type_free-${counter}" onclick="update_sale_lines();" type="radio" value="1" checked>
                        <label for="sale_type-0">Vare (for videresalg)</label>
                    </li>
                    <li>
                        <input onchange="updateMvaFree(${counter});" name="sale_type_free-${counter}" onclick="update_sale_lines();" type="radio" value="2">
                        <label for="sale_type-1">Vare (egenprodusert)</label>
                    </li>
                    <li>
                        <input  onchange="updateMvaFree(${counter});" name="sale_type_free-${counter}" onclick="update_sale_lines();" type="radio" value="3">
                        <label for="sale_type-2">Tjeneste</label>
                    </li>
                    <li>
                        <input class="disabled_func" disabled onchange="updateMvaFree(${counter});" name="sale_type_free-${counter}" onclick="update_sale_lines();" type="radio" value="4">
                        <label class="disabled_func" for="sale_type-3">Annet</label>
                    </li>
                </ul>
                <div class="sf-line-input">
                    <h4 class="sf-header-hidden">Kommentar</h4>
                    <input id="sale_comment-${counter}" name="comment_free" placeholder="Kommentar (ikke påkrevd)" type="text">
                </div>
            </div>
            <div class="sf-line-input line-split">
                <h4 class="sf-header-hidden">Pris</h4>
                <input id="price-${counter}" name="price_free" type="text" value="0.00" onchange="update_sale_lines(); check_price(${counter});">
            </div>
            <div class="sf-line-input line-split">
                <h4 class="sf-header-hidden">Rabatt</h4>
                <input id="discount-${counter}" name="discount_free" min="0" max="100" type="text" value="0" onchange="update_sale_lines(); check_discount(${counter});">
            </div>
            <div class="sf-line-input line-split">
                <h4 class="sf-header-hidden">Antall</h4>
                <input id="amount-${counter}" name="quantity_free" type="number" value="1" onchange="update_sale_lines(); check_amount(${counter});">
            </div>
            <div class="sf-line-input line-split">
                <h4 class="sf-header-hidden">Mva</h4>
                <select id="sale_vat-${counter}" name="sale_vat_free" onchange="update_sale_lines()">
                    {# Populate for videresalg, default #}
                    <option value=3>25% (Vanlige salg til Norge med 25% mva.)</option>
                    <option value=31>15% (Vanlige salg til Norge med 15% mva. Næringsmidler etc.)</option>
                    <option value=32>11,11% (Råfisk. Kun dersom firmaets primære salsgsobjekt)</option>
                    <option value=5>Fritatt (Salg som er fritatt for avgift)</option>
                    <option value=52>Utførsel (Varer som er fritatt for mva. ved eksport)</option>
                    <option value=6>Utenfor (Salg til Norge som ligger utenfor merverdiavgiftsloven)</option>
                </select>
            </div>
            <div class="sf-line-input sf-line-button">
                <p class="sf-line-total" name="total_free" id="sf-line-total-${counter}">0.00</p>
                <input class="sf-button" id="sf-button-${counter}" name="delete_free" type="button" Value="Slett linje" onclick="remove_sale_line(this.parentNode.parentNode.id)">
            </div>
            `;
    }
}
</script>
